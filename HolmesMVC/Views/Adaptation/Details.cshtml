@using HolmesMVC
@using HolmesMVC.Enums
@model HolmesMVC.Models.ViewModels.AdaptView

@{
    ViewBag.Title = Model.DisplayName;
}

<section class="leftfloatdetails">
<h2 class="detailscategory">Adaptation</h2>
<h2 class="detailsheader">@ViewBag.Title
    @if (!string.IsNullOrEmpty(Model.Translation))
    {
        <span style="font-weight: normal; font-size: small;"><br /><i>@Model.Translation</i></span>
    }
    </h2>
</section>

<section class="rightfloatdetails">
    @if (Model.HolmesActors.Any() && Model.HolmesActors.First().Pic != null)
    {
        <a href="@Url.Action("Details", "Actor", new { id = Model.HolmesActors.First().ID })"><img style="border: none;" src="@Model.HolmesActors.First().Pic" width="150"/></a>
    }
    else
    {
        <i>(no Holmes picture)</i>
    }
    @if (Model.WatsonActors.Any() && Model.WatsonActors.First().Pic != null)
    {<a href="@Url.Action("Details", "Actor", new { id = Model.WatsonActors.First().ID })"><img style="border: none;" src="@Model.WatsonActors.First().Pic" width="150"/></a>}
    else
    {
        <i>(no Watson picture)</i>
    }
</section>
<section class="leftfloatdetails">
<p>
    This @Model.MediumName adaptation
    @if (Model.Episodes.Any())
    {
        <text>began in @Model.DateOfFirstEpisode.Year, and </text>
    }
    was made by
    @if (string.IsNullOrWhiteSpace(Model.Company))
    {
        <text>an unknown company.</text>
    }
    else
    {
        <text>@Model.Company.</text>
    }
@if (Model.DisplayName != "Canon" && (Model.MediumName == "Television" || Model.MediumName == "Film"))
{
    <text><br/>IMDb: <a href="@string.Format("http://www.imdb.com/find?q=" + Model.DisplayName + " " + Model.DateOfFirstEpisode.Year + "")">@Model.DisplayName</a> <i>(link not verified)</i></text>
}
</p>
@if (Model.DisplayName != "Canon")
{
    <p>
        Sherlock Holmes @Html.Partial("_PlayedBy", Model.HolmesActors)<br />
        Dr. Watson @Html.Partial("_PlayedBy", Model.WatsonActors)
    </p>
}

@if (Request.IsAuthenticated)
{
    <p>@Html.ActionLink("Add episode", "Create", "Episode", new { Model.ID }, null)
        <br />
        @Html.ActionLink("Mass-add appearances to episodes", "MassAdd", "Appearance", new { Model.ID }, null)
    </p>
}
@Html.Action("DatabaseLinks", "Home", new { table = "Adaptation", id = Model.ID })
    </section>
@if (Model.Episodes.Any())
{
    <div class="clear-fix"></div>
    <div id="timelinecontainer">
        <canvas id="timeline">Turn on &lt;canvas&gt;.</canvas>
    </div>
}
<table>
    @{
        var lastEpisode = new HolmesMVC.Models.Episode();
        var i = 0;
        foreach (var e in Model.Episodes)
        {
            if (i > 0 && lastEpisode.Season1.AirOrder != e.Season1.AirOrder)
            {
                var seasontext = "Season " + e.Season1.AirOrder;
                if (!string.IsNullOrWhiteSpace(e.Season1.Name))
                {
                    seasontext = e.Season1.Name;
                }
        <text><tr>
            <td colspan="2" class="adaptseason">
                <h3>@seasontext @if (!string.IsNullOrEmpty(e.Season1.Translation))
                                {<span style="font-weight: normal; font-size: small;"><br /><i>@e.Season1.Translation</i></span> }</h3>
            </td>
        </tr></text>
            }
            if (i == 0 && !Model.SingleSeason)
            {
                var seasontext = "Season 1";
                if (!string.IsNullOrWhiteSpace(e.Season1.Name))
                {
                    seasontext = e.Season1.Name;
                }
        <text><tr>
            <td colspan="2" class="adaptseason">
                <h3>@seasontext @if (!string.IsNullOrEmpty(e.Season1.Translation))
                                {<span style="font-weight: normal; font-size: small;"><br /><i>@e.Season1.Translation</i></span> }</h3>
            </td>
        </tr></text>
            }
        <text>
        <tr>
            @{ string airdateFormat = "dd MMM yyyy"; }
            @if (e.AirdatePrecision == (int)DatePrecision.Month)
            {
                airdateFormat = "MMMM yyyy";
            }
            else if (e.AirdatePrecision == (int)DatePrecision.Year)
            {
                airdateFormat = "yyyy";
            }
            <td>@e.Airdate.ToString(airdateFormat)</td>
            @{var name = Shared.DisplayName(e);}
            <td>@Html.ActionLink(name, "Details", "Episode", new { e.ID }, null) @if (!string.IsNullOrEmpty(e.Translation))
                                                                                 { <span style="font-weight: normal; font-size: small;"><i>@e.Translation</i></span> }</td>
        </tr>
        </text>
                                                                                 lastEpisode = e;
                                                                                 i++;
        }
    }
</table>

@section Scripts {
    <script type="text/javascript" src="~/Scripts/Apdore-timeline.js"></script>

    <script>
        try {
        // Canvas timelines
        
        var canvas = $('#timeline')[0];
        var ctx = canvas.getContext('2d');

        var startYear = 0;
        var startMonth = 0;
        var endYear = 0;
        var endMonth = 0;

        var spottyValues = "";
        
        @if (Model.Episodes.Any())
        {
         <text>
        startYear = @Model.Episodes.First().Airdate.Year;
        startMonth = @Model.Episodes.First().Airdate.Month;
        endYear = @Model.Episodes.Last().Airdate.Year;
        endMonth = @Model.Episodes.Last().Airdate.Month;
        </text>
            string spottyValues = "[";
            foreach (var ep in Model.Episodes)
            {
                spottyValues += ep.Airdate.Year + ", " + ep.Airdate.Month + ", ";
            }
            spottyValues = spottyValues.Substring(0, spottyValues.Length - 2);
            spottyValues += "]";
<text>
        function spottyTimeline() {
            drawTimeline(startYear, startMonth, endYear, endMonth, canvas, ctx, @spottyValues, true);
        }
        $(document).ready(function() {
            spottyTimeline();
        });
</text>
        }
        } catch (err) {
            // shut up, IE9
        }
    </script>
}

